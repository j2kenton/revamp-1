#!/usr/bin/env sh

# Skip when running inside CI or when explicitly opted out.
if [ "${CI:-}" = "true" ] || [ "${SKIP_POST_COMMIT_TESTS:-}" = "true" ]; then
	exit 0
fi

if ! command -v npm >/dev/null 2>&1; then
	echo "husky (post-commit) • npm not found in PATH, skipping test run."
	exit 0
fi

echo "husky (post-commit) • running full test suite..."

if npm run test; then
	echo "husky (post-commit) • tests passed ✅"
	# Optional: Uncomment to get notified on success too
	# powershell.exe -Command "& {Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show('All tests passed!', 'Git Hook - Success', 0, 64)}"
else
	status=$?
	echo "husky (post-commit) • tests failed. Fix issues and rerun 'npm run test'."
	echo "husky (post-commit) • amend or follow-up commit may be required."

	# Show Windows notification popup
	powershell.exe -Command "& {Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show('Tests failed after commit! Check OUTPUT pane for details.', 'Git Hook - Test Failure', 0, 48)}"

	exit "$status"
fi
